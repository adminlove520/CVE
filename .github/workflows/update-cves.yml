name: CVE Update

on:
  # 每5分钟运行一次
  schedule:
    - cron: '*/5 * * * *'
  # 允许手动触发
  workflow_dispatch:
    inputs:
      params:
        description: '命令行参数'
        required: false
        default: ''

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}

jobs:
  update-cves:
    environment: deployment
    runs-on: ubuntu-latest
    env:
      CVE_SERVICES_URL: https://cveawg.mitre.org
      CVE_SERVICES_RECORDS_PER_PAGE: 500
      CVE_ORG_URL: https://www.cve.org
      CVES_BASE_DIRECTORY: data
      CVES_RECENT_ACTIVITIES_FILENAME: recent_activities.json
      CVES_DEFAULT_UPDATE_LOOKBACK_IN_MINS: 180
      CVES_DEFAULT_DELTA_LOG_HISTORY_IN_DAYS: 30
      DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libxml2-dev libxslt1-dev python3-dev

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --only-binary :all: lxml==4.9.3
          pip install -e .

      - name: Update CVEs
        run: |
          # 设置时间戳
          export TEMP_TIMESTAMP=$(date '+%Y-%m-%d_%H%M_UTC')
          echo "out=$TEMP_TIMESTAMP" >> $GITHUB_OUTPUT
          
          # 拉取最新更改
          git pull
          
          # 配置 Git
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "CVE Monitor Github Action"
          
          # 获取上次更新时间
          if [ -f "$CVES_BASE_DIRECTORY/deltaLog.json" ]; then
            export PREV_TS=$(jq -r '.[0].fetchTime' < $CVES_BASE_DIRECTORY/deltaLog.json)
          else
            # 如果没有 deltaLog.json，使用3小时前的时间
            export PREV_TS=$(date -d '3 hours ago' -u +"%Y-%m-%dT%H:%M:%SZ")
          fi
          
          # 创建日志目录
          mkdir -p logs
          
          # 运行更新脚本
          python scripts/update_cves.py --start=$PREV_TS
          
          # 更新 deltaLog.json
          if [ ! -f "$CVES_BASE_DIRECTORY/deltaLog.json" ]; then
            echo "[]" > "$CVES_BASE_DIRECTORY/deltaLog.json"
          fi
          
          NOW_TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          NEW_ENTRY="{\"fetchTime\":\"$NOW_TS\",\"count\":$(jq '.metadata.total_count' $CVES_BASE_DIRECTORY/cves.json)}"
          
          # 保持最近30天的记录
          jq --arg entry "$NEW_ENTRY" '. [($entry|fromjson)] + .[0:29]' \
            $CVES_BASE_DIRECTORY/deltaLog.json > $CVES_BASE_DIRECTORY/deltaLog.json.tmp
          mv $CVES_BASE_DIRECTORY/deltaLog.json.tmp $CVES_BASE_DIRECTORY/deltaLog.json

      - name: Commit and push if changed
        run: |
          git add data/ logs/
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update CVE data and logs" && git push) 